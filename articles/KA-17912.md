---
title: "Explicación de los directorios de almacenamiento en caché"
description: '"Descubra cómo se produce el almacenamiento en caché de Dispatcher en Adobe Experience Manager y cómo se puede configurar".'
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: AEM "KCS, comprenda los directorios de almacenamiento en caché, las prácticas recomendadas de Adobe Experience Manager, los directorios de almacenamiento en caché"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Oleksandra Marchenko
article-created-date: "1/18/2024 3:39:17 PM"
article-published-by: Oleksandra Marchenko
article-published-date: "1/18/2024 3:44:47 PM"
version-number: 9
article-number: KA-17912
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=063c58b9-17b6-ee11-a569-6045bd006a22"
source-git-commit: 56cc56c649cc946c55a99e24ed8f27165db207e3
workflow-type: tm+mt
source-wordcount: '1533'
ht-degree: 0%

---

# Explicación de los directorios de almacenamiento en caché


Este documento explica cómo se produce el almacenamiento en caché de Dispatcher y cómo se puede configurar.

## Descripción {#description}


<b>Entorno</b>
Adobe Experience Manager

<b>Problema/Síntomas</b>
Este documento explica cómo se produce el almacenamiento en caché de Dispatcher y cómo se puede configurar.
[Tabla de contenido](https://experienceleague.adobe.com/docs/experience-cloud-kcs/kbarticles/KA-17490.html)

## Resolución {#resolution}


<b>Directorios de almacenamiento en caché</b>

Utilizamos los siguientes directorios de caché predeterminados en nuestras instalaciones de línea de base

- Autor

   - /mnt/var/www/author
- Editor

   - /mnt/var/www/html


Cuando cada solicitud atraviesa Dispatcher, las solicitudes siguen las reglas configuradas para mantener una versión en caché local de la respuesta de los elementos aptos.

<b>Nota:</b>

AEM De forma intencionada, mantenemos la carga de trabajo publicada separada de la carga de trabajo de autor porque cuando Apache busca un archivo en DocumentRoot, no sabe de qué instancia de provino. Por lo tanto, aunque tenga la caché deshabilitada en el conjunto de servidores de creación, si el DocumentRoot del autor es el mismo que el editor, servirá los archivos de la caché cuando esté presente. Esto significa que servirá archivos de autor de la caché publicada y proporcionará a los visitantes una experiencia de coincidencia de mezcla realmente horrible. Mantener directorios DocumentRoot separados para contenido publicado diferente también es una muy mala idea. Tendrá que crear varios elementos en caché que no difieran entre sitios, como clientlibs, así como configurar un agente de vaciado de replicación para cada DocumentRoot que configure, lo que aumenta la cantidad de sobrecarga de vaciado con cada activación de página. Confíe en el área de nombres de los archivos y sus rutas de acceso en caché completas y evite tener varios DocumentRoots para los sitios publicados.



<b>Archivos de configuración</b>

Dispatcher controla lo que califica como caché en la sección /cache de cualquier archivo de granja. 
En las granjas de configuración de línea de base de AMS, encontrará nuestras inclusiones como se muestra a continuación:


```
/cache { 
    /rules { 
        $include "/etc/httpd/conf.dispatcher.d/cache/ams_author_cache.any" 
    }
```


Al crear las reglas para qué almacenar en caché o no, consulte la documentación [aquí](https://experienceleague.adobe.com/docs/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html?lang=en#configuring-the-dispatcher-cache-cache)



<b>Autor de almacenamiento en caché</b>

Hay muchas implementaciones que hemos visto en las que las personas no almacenan en caché el contenido del autor. 
Se están perdiendo una gran actualización en rendimiento y capacidad de respuesta para sus autores.

Analicemos la estrategia adoptada al configurar nuestra granja de autores para almacenar correctamente la caché.

Esta es una sección base de autor/caché de nuestro archivo de granja de autores:


```
/cache { 
    /docroot "/mnt/var/www/author" 
    /statfileslevel "2" 
    /allowAuthorized "1" 
    /rules { 
        $include "/etc/httpd/conf.dispatcher.d/cache/ams_author_cache.any" 
    } 
    /invalidate { 
        /0000 { 
            /glob "*" 
            /type "allow" 
        } 
    } 
    /allowedClients { 
        /0000 { 
            /glob "*.*.*.*" 
            /type "deny" 
        } 
        $include "/etc/httpd/conf.dispatcher.d/cache/ams_author_invalidate_allowed.any" 
    } 
}
```


Lo importante que hay que tener en cuenta aquí es que la <b>/docroot</b> se establece en el directorio de caché del autor.

<b>Nota:</b>

Asegúrese de que DocumentRoot en el archivo .vhost del autor coincida con el parámetro /docroot de granjas.

Las reglas de caché incluyen una instrucción que incluye el archivo <b>/etc/httpd/conf.dispatcher.d/cache/ams_author_cache.any</b> que contiene estas reglas:


```
/0000 { 
 /glob "*" 
 /type "deny" 
} 
/0001 { 
 /glob "/libs/*" 
 /type "allow" 
} 
/0002 { 
 /glob "/libs/*.html" 
 /type "deny" 
} 
/0003 { 
 /glob "/libs/granite/csrf/token.json" 
 /type "deny" 
} 
/0004 { 
 /glob "/apps/*" 
 /type "allow" 
} 
/0005 { 
 /glob "/apps/*.html" 
 /type "deny" 
} 
/0006 { 
 /glob "/libs/cq/core/content/welcome.*" 
 /type "deny" 
}
```


En el caso de un autor, el contenido cambia todo el tiempo y a propósito. Solo desea almacenar en caché elementos que no cambiarán con frecuencia.
AEM Tenemos reglas para almacenar en caché /libs porque forman parte de la instalación de línea de base de la aplicación y cambiarían hasta que haya instalado un paquete de servicio, un paquete de correcciones acumulativas, una actualización o una revisión. El almacenamiento en caché de estos elementos tiene mucho sentido y beneficia en gran medida la experiencia de creación de los usuarios finales que utilizan el sitio.

<b>Nota:</b>

Tenga en cuenta que estas reglas también almacenan en caché <b>/apps</b> aquí es donde reside el código de aplicación personalizado. Si está desarrollando su código en esta instancia, resultará muy confuso cuando guarde el archivo y no vea si se refleja en la interfaz de usuario debido a que sirve una copia en caché. AEM La intención aquí es que si realiza una implementación del código en la caché de creación, también sería poco frecuente y parte de los pasos de implementación deberían ser borrar la caché de creación. Una vez más, la ventaja es enorme, lo que hace que su código almacenable en caché se ejecute más rápido para los usuarios finales.



<b>ServeOnStale (también conocido como Serve on Stale / SOS)</b>

Esta es una de esas joyas de una funcionalidad de Dispatcher. Si el editor está bajo carga o no responde, normalmente genera un código de respuesta http 502 o 503. Si esto sucede y esta función está habilitada, se le indicará al despachante que siga mostrando el contenido que aún esté en la caché como mejor esfuerzo, incluso si no es una copia nueva. Es mejor servir algo si lo tiene, en lugar de mostrar simplemente un mensaje de error que no ofrece funcionalidad.

<b>Nota:</b>

Tenga en cuenta que si el procesador del editor tiene un tiempo de espera de socket o un mensaje de error 500, esta función no se almacenará en déclencheur. AEM Si no se puede acceder a la aplicación, esta función no hace nada.

Esta configuración se puede establecer en cualquier granja de servidores, pero su aplicación a los archivos de granja de servidores publicados solo tiene sentido. Este es un ejemplo de sintaxis de la función habilitada en un archivo de granja:


```
/cache { 
    /serveStaleOnError "1"
```




<b>Almacenamiento en caché de páginas con parámetros/argumentos de consulta</b>

<b>Nota:</b>

Uno de los comportamientos normales del módulo de Dispatcher es que si una solicitud tiene un parámetro de consulta en el URI (normalmente se muestra como /content/page.html<b>?myquery=value</b>AEM ), omitirá el almacenamiento en caché del archivo e irá directamente a la instancia de. Está considerando esta solicitud como una página dinámica y no debería almacenarse en la caché. Esto puede causar un efecto negativo en la eficacia de la caché.

AEM Si tiene páginas en el entorno de que toman argumentos de GET o parámetros de consulta en la línea de dirección que ayudan a que la página funcione, pero no representan HTML diferentes, son buenos candidatos para este elemento de configuración.

Puede indicarle al despachante qué argumentos ignorar y seguir almacenando en caché la página.

Por ejemplo, alguien ha creado un mecanismo de referencia de vínculos profundos de medios sociales que utiliza la referencia de argumento en la URI para saber de dónde procede la persona.

<b>Ejemplo de uso:</b>

[https://www.retail.com/home.html?reference=android](https://www.retail.com/home.html?reference=android)

[https://www.retail.com/home.html?reference=facebook](https://www.retail.com/home.html?reference=facebook)

La página se puede almacenar en caché al 100 %, pero no lo hace porque los argumentos están presentes. 
Para solucionar esto, agregamos la siguiente sección a nuestro archivo de configuración de granja:


```
/cache { 
    /ignoreUrlParams { 
        /0001 { /glob "*" /type "deny" } 
        /0002 { /glob "reference" /type "allow" } 
    }
```


Ahora, cuando el despachante vea la solicitud, ignorará el hecho de que la solicitud tiene el parámetro de consulta de referencia y aún almacenará en caché la página.



<b>Almacenamiento en caché de encabezados de respuesta</b>

Es bastante obvio que Dispatcher almacena en caché páginas .html y clientlibs, pero ¿sabía que también puede almacenar en caché encabezados de respuesta particulares junto al contenido en un archivo con el mismo nombre pero con una extensión de archivo .h? Esto permite la siguiente respuesta no solo al contenido, sino a los encabezados de respuesta que deben ir con él desde la caché.

AEM Puede gestionar algo más que la codificación UTF-8.

A veces, los elementos tienen encabezados especiales que ayudan a controlar los detalles de codificación del TTL de la caché y las marcas de tiempo de la última modificación.

Estos valores, cuando se almacenan en caché, se eliminan de forma predeterminada, y el servidor web httpd de Apache hará su propio trabajo de procesamiento del recurso con sus métodos normales de administración de archivos, que normalmente se limita a adivinar el tipo de MIME en función de las extensiones de archivo.

Si tiene que Dispatcher almacene en caché el recurso y los encabezados deseados, puede exponer la experiencia adecuada y asegurarse de que todos los detalles llegan al explorador de los clientes.

Este es un ejemplo de una granja con los encabezados para almacenar en caché especificados:


```
/cache { 
 /headers { 
  "Cache-Control" 
  "Content-Disposition" 
  "Content-Type" 
  "Expires" 
  "Last-Modified" 
  "X-Content-Type-Options" 
 } 
}
```


AEM En el ejemplo, se han configurado para que sirva encabezados que la CDN busca para saber cuándo invalidar su caché. AEM Lo que significa que ahora puede dictar correctamente qué archivos se invalidan en función de los encabezados.

<b>Nota:</b>

Tenga en cuenta que no puede utilizar expresiones regulares ni la coincidencia glob. Es una lista literal de los encabezados que se van a almacenar en caché. Coloque solo en una lista de los encabezados literales que desea que almacene en caché.



<b>Invalidar automáticamente el período de gracia</b>

AEM En los sistemas de datos que tienen mucha actividad de los autores que realizan muchas activaciones de la página, puede tener una condición de carrera en la que se producen invalidaciones repetidas. Las solicitudes de vaciado muy repetidas son innecesarias y puede incorporar cierta tolerancia para no repetir un vaciado hasta que se haya borrado el período de gracia.

<b>Ejemplo de cómo funciona esto:</b>

Si tiene cinco solicitudes para invalidar /content/example/en/, todas se producen en un periodo de 3 segundos.

Con esta función desactivada, se invalidaría el directorio de caché /content/example/en/ 5 veces.

Con esta función activada y configurada en 5 segundos, se invalidaría el directorio de caché /content/example/en/once.

Esta es una sintaxis de ejemplo de esta función que se está configurando para un período de gracia de 5 segundos:


```
/cache { 
    /gracePeriod "5"
```




<b>Invalidación basada en TTL</b>

Una característica más reciente del módulo de Dispatcher fue <b>Tiempo que puede permanecer activo (TTL)</b> opciones de invalidación basadas en para elementos en caché. Cuando un elemento se almacena en caché, busca la presencia de encabezados de control de caché y genera un archivo en el directorio de caché con el mismo nombre y un <b>.ttl</b> extensión.

Este es un ejemplo de la función que se está configurando en el archivo de configuración de la granja:


```
/cache { 
    /enableTTL "1"
```


<b>Nota:</b>

AEM Tenga en cuenta que aún debe configurarse el envío de encabezados TTL para que el despachante los respete. AEM Alternar esta función solo permite que Dispatcher sepa cuándo quitar los archivos para los que ha enviado encabezados de control de caché. AEM Si no comienza a enviar encabezados TTL, Dispatcher no hará nada especial aquí.



<b>Reglas de filtro de caché</b>

A continuación se muestra un ejemplo de una configuración de línea de base para qué elementos almacenar en caché en un editor:


```
/cache{ 
    /0000 { 
        /glob "*" 
        /type "allow" 
    } 
    /0001 { 
        /glob "/libs/granite/csrf/token.json" 
        /type "deny" 
    }
```


Queremos que nuestro sitio publicado sea lo más voraz posible y almacenar todo en caché.

Si hay elementos que rompen la experiencia cuando se almacenan en caché, puede agregar reglas para eliminar la opción de almacenar en caché ese elemento. Como puede ver en el ejemplo anterior, los tokens csrf nunca deben almacenarse en caché y se han excluido. Puede encontrar más información sobre cómo escribir estas reglas [aquí](https://experienceleague.adobe.com/docs/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html?lang=en#configuring-the-dispatcher-cache-cache).
